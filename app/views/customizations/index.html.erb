<h1>Customization</h1>
<div class="lesson-select">
  <div class="card">
      <button class="btn mb-3 mx-auto" id="customization-btn">Customize your topics</button> 
  </div>
</div>

<!-- Customization 隱藏欄位 -->
<div class="card d-none">
  <div class="card-body">
    <%= form_for @topic do |f|%>
      <div class="form-row">
        <div class="form-group mr-2">
          <%= f.label :content %>
          <%= f.text_field :content, class: 'form-control' %>
          <%= f.hidden_field :type, valus: 'Customization' %>
        </div>
        <div class="form-group">
          <%= f.submit class: 'btn btn-primary', id: 'customization_submit' %>
        </div>
      </div>
    <% end %>
  </div>   
</div>

<div class="lesson-select">
  <% start = 1%>
  <div class= "card">
    <% @user_topics.each do |topic| %>
      <% if topic.topic %>
        <div class="card-body" style="width: 15rem">
          <% if current_user %>
            <div class="accracy d-none"><%= current_user.user_topics.where(topic_id: topic.topic_id).order('accuracy').first.accuracy %></div>
          <% end %>

          <h5 class="card-title" id="lessonTitle">Lesson<%= "#{start}" %></h5>
          
            <p class="card-text ellipsis"><%= topic.topic.content %></p>
          
          <%= link_to "Start", send("customization_path", id: topic.topic.id), class: "btn btn-primary justify-content-center ", id: "play-start" %>
          <%= link_to "編輯", edit_customization_path(topic.topic.id), class: 'btn' %>
          <%= link_to "刪除", customization_path(topic.topic.id), class: 'btn', id: "delete-custom-btn", method: "DELETE" %>

          <div class="progress d-flex" id="lessonBar" style="height: 10px;">
            <div class="progress-bar " role="progressbar"  style="width: 0%;" aria-valuenow="25" aria-valuemin="0" aria-valuemax="100"></div>
          </div> 
        </div>
        <% start += 1 %>
      <% end %>
    <% end %>
  </div>
</div>

<script>
  let customizationBtn = document.querySelector('#customization-btn')
  let deleteCustomBtn = document.querySelectorAll('#delete-custom-btn')
  let customizationContent = document.querySelector('#customization_content')
  // let roomDescription = document.querySelector('#room_description')
  let createBtn = document.querySelector('#customization_submit')
  
  customizationBtn.addEventListener('click', () => {
    getData();
  })
  async function getData() {
    const { value: formValues } = await Swal.fire({
      title: 'Customize your topics',
      showCancelButton: true,
      confirmButtonText: 'Yes, Create it!',
      html:
        '<textarea id="swal-input1" class="swal2-input" placeholder="Topic content"></textarea>',
      focusConfirm: false,
      preConfirm: () => {
        let topicContent = document.getElementById('swal-input1')
        // let inputDescription = document.getElementById('swal-input2')
        if (topicContent.value === '') {
          Swal.showValidationMessage(
            `Request failed: Name and Description `
          )
        } else {
          return [
            topicContent.value,
          ]
        }
      }
    })

    if (formValues) {

      let timerInterval
      Swal.fire({
        title: 'Topic has created!',
        timer: 2000,
        timerProgressBar: false,
        onClose: () => {
          clearInterval(timerInterval)
        }
      }).then(() => {
        customizationContent.value = formValues[0]
        createBtn.click()
      })
    }
  }
  /* delete room 彈出視窗 */
  let stepStatus = false
  deleteCustomBtn.forEach((deleteBtn) => {
    deleteBtn.addEventListener('click', (btn) => {
      if (stepStatus === false) {
        btn.preventDefault();
        btn.stopPropagation();
          Swal.fire({
          title: 'Are you sure?',
          text: "You won't be able to revert this!",
          icon: 'warning',
          showCancelButton: true,
          confirmButtonColor: '#3085d6',
          cancelButtonColor: '#d33',
          confirmButtonText: 'Yes, delete it!'
        }).then((result) => {
          if (result.value) {
            Swal.fire({
              icon: 'success',
              title: 'Your room has deleted!',
              showConfirmButton: false,
              timer: 1500
            })
            stepStatus = true;
            setTimeout(() => {
              deleteBtn.click();
            }, 1000);
          }
        })
      }
      if (stepStatus === true) {
        stepStatus = false
      }
    })
  })
</script>